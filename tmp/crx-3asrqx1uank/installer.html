<!doctype html>
<html>
    <head>
        <style>
            body { margin: 15%; text-align: center; }
            button { background: green; border: 1px solid #000; color: #fff; cursor: pointer; font-size: 200%; padding: 15px 60px; text-transform: uppercase; }
        </style>
    </head>
    <body>
        <button>Play</button>
        <script>
            (function() {
                var apps = {};

                var mozApps = 'mozApps' in navigator;
                var chromeApps = 'chrome' in window;

                var manifest = 'http://cvan.github.io/HexGL';

                if (mozApps) {
                    manifest = 'http://localhost:5000/app/hexgl/manifest/firefox';
                    function getInstalled() {
                        // Don't getInstalled if the page isn't visible.
                        if (document.hidden) {
                            return;
                        }
                        // Get list of installed apps and mark as such.
                        var r = navigator.mozApps.getInstalled();
                        r.onsuccess = function() {
                            Object.keys(r.result, function(val) {
                                apps[val.manifestURL.split('?')[0]] = val;
                            });
                        };
                    }
                    getInstalled();
                } else if (chromeApps) {
                    //manifest = 'http://localhost:5000/app/hexgl/manifest/chrome.crx';
                    manifest = 'http://localhost:5000/static/hexgl.crx';
                }

                var button = document.querySelector('button');
                button.addEventListener('click', function() {
                    if (mozApps) {
                        if (manifest in apps) {
                            apps[manifest].launch();
                            return;
                        }
                        var request = navigator.mozApps.install(manifest);
                        request.onsuccess = function() {
                            console.error('Install onsuccess', manifest);
                            var app = this.result;
                            var status;
                            var isInstalled = setInterval(function() {
                                status = request.result.installState;
                                if (status == 'installed') {
                                    console.log('Install succeded', manifest);
                                    app.launch();
                                    clearInterval(isInstalled);
                                }
                            }, 250);
                        };
                        request.onerror = function() {
                            console.error('Install failed:', this.error.name);
                        };
                    } else if (chromeApps) {
                        //window.location = manifest;
                        chrome.webstore.install(manifest)
                    }
                }, false);
            })();
        </script>
    </body>
</html>
